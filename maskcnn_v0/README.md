# 细胞实例分割与分类系统

## 系统简介

这是一个完整的细胞实例分割和分类系统，能够自动检测、分割和分类脱落细胞涂片中的所有细胞。该系统采用混合深度学习架构，结合了多种先进模型的优点，性能卓越且完全可本地化部署。

## 主要功能

- **数据预处理**：将`.dat`边界坐标文件转换为各种格式的分割掩码数据集
- **模型训练**：使用混合架构训练细胞分割和分类模型
- **批量推理**：对大量图像进行批量处理
- **可视化**：直观展示分割结果和统计信息
- **用户界面**：易用的图形界面，支持所有系统功能

## 支持的细胞类型

- Dyskeratotic (异常角化细胞)
- Koilocytotic (空泡细胞)
- Metaplastic (化生细胞)
- Parabasal (副基底细胞)
- Superficial-Intermediate (表面-中间层细胞)

## 系统要求

- **操作系统**：Windows 10/11
- **Python**：3.8或更高版本
- **GPU**：建议使用支持CUDA的NVIDIA显卡（用于加速）
- **RAM**：最低8GB，推荐16GB或更高

## 安装

### 方法1: 使用批处理文件（推荐）

1. 双击根目录中的`安装细胞分割系统依赖.bat`文件
2. 等待安装完成

### 方法2: 手动安装

1. 打开命令提示符或PowerShell
2. 进入项目目录：`cd 项目路径/cell_segmentation`
3. 运行安装脚本：`python install_dependencies.py`

### 高级功能安装（可选）

某些高级功能需要额外依赖：

1. **Detectron2**：需要安装Git，然后运行：
   ```
   pip install 'git+https://github.com/facebookresearch/detectron2.git'
   ```

> **注意**：如果没有安装Git，系统将自动使用YOLOv8和CellPose模型。

## 快速开始

1. 双击`启动细胞分割系统.bat`文件
2. 选择所需的操作：
   - 启动图形界面
   - 预处理数据
   - 训练模型
   - 运行推理

## 详细使用指南

### 数据预处理

数据预处理模块将原始的`.dat`边界坐标文件转换为用于训练的标准格式数据集。

1. 在图形界面中，切换到"数据准备"选项卡
2. 选择包含原始`.dat`文件和`.bmp`图像的输入目录
3. 选择输出目录
4. 选择输出格式（YOLO、COCO或掩码）
5. 点击"运行预处理"按钮

也可以通过命令行进行预处理：

```
python run.py preprocess --input <输入目录> --output <输出目录> --format yolo
```

### 模型训练

训练模块使用混合架构训练细胞分割和分类模型。

1. 在图形界面中，切换到"训练"选项卡
2. 选择预处理后的数据集目录
3. 设置训练参数（周期数、批量大小、学习率等）
4. 点击"开始训练"按钮

也可以通过命令行进行训练：

```
python run.py train --data <数据集目录> --output <输出目录> --epochs 50
```

### 推理

推理模块使用训练好的模型进行细胞分割和分类。

1. 在图形界面中，切换到"推理"选项卡
2. 选择模型文件
3. 加载模型
4. 打开图像或图像目录
5. 点击"运行推理"按钮

也可以通过命令行进行推理：

```
python run.py inference --model <模型路径> --image <图像路径> --output <输出目录>
```

## 项目结构

```
cell_segmentation/
├── data/                  # 数据集目录
├── models/                # 模型定义和权重
│   ├── checkpoints/      # 模型检查点
│   ├── cell_segmentation.py
│   └── hybrid_cell_segmentation.py
├── ui/                    # 用户界面
│   └── cell_segmentation_ui.py
├── utils/                 # 工具函数
│   └── dat_to_masks.py    # 数据转换工具
├── output/                # 训练输出目录
├── inference.py           # 推理模块
└── run.py                 # 主入口脚本
```

## 混合架构说明

本系统采用了混合深度学习架构，结合了多种先进模型的优点：

- **Mask R-CNN**：强大的实例分割能力
- **DINO特征**：改进的特征表示，提高小目标检测能力
- **Cellpose风格后处理**：生物医学领域专用的分割优化

这种混合架构能够同时保证高精度和高速度，特别适合细胞分割任务的复杂性和多样性。

## 常见问题

**问：系统支持哪些图像格式？**

答：系统支持BMP、JPG和PNG格式的图像。

**问：如何改进模型性能？**

答：可以通过增加训练数据、调整学习率、更改批量大小或增加训练周期来改进性能。

**问：可以添加新的细胞类型吗？**

答：是的，您可以通过修改`utils/dat_to_masks.py`中的`CLASS_MAPPING`字典来添加新的细胞类型。

**问：如何导出训练好的模型？**

答：训练好的模型会自动保存在输出目录下的`best_model.pth`文件中。

**问：我看到"Git不可用"的错误信息，这有关系吗？**

答：如果您看到Git不可用的错误，这意味着系统将无法使用Detectron2（Mask R-CNN）模型。系统会自动使用其他可用模型（YOLOv8和CellPose）继续工作。如果需要Detectron2功能，请安装Git（https://git-scm.com/download/win），然后通过命令行安装Detectron2。

**问：哪个模型最适合细胞分割？**

答：
- **YOLOv8**：速度快，准确度高，适合大多数场景
- **CellPose**：专为细胞分割优化，对形状有很好的识别
- **Mask R-CNN**：处理复杂重叠细胞效果好

## 技术支持

如有问题或建议，请联系系统开发者。
